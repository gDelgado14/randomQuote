<!DOCTYPE html>
<html>
	<head>
		
		<!-- Compiled and minified CSS -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">
        
        <!--Import Google Icon Font-->
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" data-font="test">
		
        <!--Let browser know website is optimized for mobile-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        
        <!-- include Firebase library -->
        <script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
        
        <style>
	        
            h1,
            h4 {
                font-weight: light;
                font-style: italic;
            }
            
            .brand-logo {
	            position: relative;
	            left: 30px;
            }
            
            /*.nav-wrapper ul {
	            position: relative;
	            right: 30px;
            }*/
            
            #rand-quote-div {
	            width: 243px;
            }
            
			#quote-req {
				margin-left: 15px;
			}
            
        </style>
	</head>
	<body>
		<nav>
		    <div class="nav-wrapper">
		      <a href="#" class="brand-logo"><i class="medium material-icons">chat_bubble_outline</i></a>
		      <a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>
		      <ul class="right hide-on-med-and-down">
		        <li>
		        	<a id="user" class="modal-trigger" href="#modal1"><i class="material-icons">perm_identity</i></a>
		        </li>
		      </ul>
		      <ul class="side-nav" id="mobile-demo">
			      <li>
				  	<a id="user" class="modal-trigger" href="#modal1"><i class="material-icons">perm_identity</i></a>
			      </li>
      		  </ul>
		    </div>
	  	</nav>
	  	
	  
    
  
		<main>
	    	<div class="container">
	        	
	        	<div class="row">
	    	        <h1 class="col s8 offset-s3 red-text text-lighten-2">Your Daily Quotes</h1>
	        	</div>
	        	
	        	<div class="row">
	                <div class="col offset-m3 s12 m6">
	                    <div class="card teal lighten-2 hoverable">
	                        <div class="card-content white-text">
	                            <span class="card-title">Today's Quote</span>
	                            <p id="quote-body"></p>
	                        </div>
	                        <div class="card-action">
	                            <blockquote>
	                                <span class="red-text text-lighten-4" id="auth"></span>
	                            </blockquote>
	                        </div>
	                    </div>
	                </div>
	        	</div> <!-- /.row -->
	        	
	        	<div class="row">
	            	<div id="rand-quote-div" class="col s4 m4 offset-m3 offset-s3">
	                	<a class="waves-effect waves-light btn" id="rand">random quote</a>
	            	</div> <!-- /.btn -->
	            	<div class="col s4">
		            	<a class="waves-effect waves-light btn" id="quote-submit">submit quote</a>
	            	</div>
	        	</div> <!-- /.row -->
	    	</div> 
	    	
		</main>
		
		

		<!-- Modal Structure -->
		<div id="modal1" class="modal">
			<div class="modal-content">
				<h4 class="red-text text-lighten-2 sign-up">Sign Up for YDQ!</h4>
				<h4 class="red-text text-lighten-2 sign-in" style="display: none">Welcome Back</h4>
				<div class="row">
					<a href="#" class="btn-flat sign-up" onClick="$('.sign-up').hide(); $('.sign-in').show()">Or Sign In</a>
					<a href="#" class="btn-flat sign-in" onClick="$('.sign-in').hide(); $('.sign-up').show()" style="display: none">Sign Up</a>
				</div>
				<div class="row">
					<form class="col s12">
						<div class="row sign-up">
							<div class="input-field col s6">
								<input id="name" type="text" class="validate">
								<label for="first_name">Name</label>
		        			</div>
					        <div class="input-field col s6">
					          <input id="username" type="text" class="validate">
					          <label for="last_name">Username</label>
					        </div>
		      			</div>
		      			<div class="row">
							<div class="input-field col s12">
								<input id="email" type="email" class="validate">
								<label for="email">Email</label>
							</div>
		      			</div>
						<div class="row">
							<div class="input-field col s12">
								<input id="password" type="password" class="validate">
								<label for="password">Password</label>
							</div>
						</div>
						<div class="row">
							<a href="#" id="register-user" class="btn sign-up">Sign Up</a>
							<a href="#" id="auth-user" style="display: none" class="btn sign-in">Log In</a>
						</div>
		    		</form>
		 		</div>
			</div>
			<div class="modal-footer">
			  <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Close</a>
			</div>
		</div>
		
		<div id="modal2" class="modal bottom-sheet modal-fixed-footer">
			<div class="modal-content">
				<h3 class="center-align">Quotes HQ</h3>
				<h6 class="center-align red-text text-lighten-2">Logged in as: </h6>
				<p>A bunch of text</p>
				<div class="row">
					<p>brap sdfsd sfdas sdgf gerwgewr</p>
					<p>brap</p>
					<p>brap</p>
					<p>brap</p>
					<p>brap</p>
					<p>brap</p>
					<p>brap</p>
					<p>brap</p>
					<p>brap</p>
				</div>
    		</div>
			<div class="modal-footer">
				<a href="#!" id="unauth" class="modal-action modal-close waves-effect waves-green btn-flat">Log Out</a>
				<a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Close</a>
	    	</div>
  		</div>
  		
  		<div id="modal3" class="modal modal-fixed-footer">
  			<div class="modal-content">
  				<h4 class="red-text text-lighten-2">Submit A Quote</h4>
  				<div class="row">
  					<form class="col s12">
						<div class="row">
							<div class="input-field col s6 offset-s3">
							  <textarea id="author" class="materialize-textarea validate"></textarea>
							  <label for="auth">author</label>
							</div>
						</div>
						<div class="row">
							<div class="input-field col s10 offset-s1">
							  <textarea id="quote-text" class="materialize-textarea validate"></textarea>
							  <label for="quote-text">quote</label>
							</div>
						</div>
					</form>
				</div>
    		</div>
			
			<div class="modal-footer">
				<a class="waves-effect waves-light btn" id="quote-req">Submit</a>
				<a class="modal-action modal-close waves-effect waves-green btn">Close</a>
    		</div>
  		</div>
		
       	
        <!--Import jQuery before materialize.js-->
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <!-- Compiled and minified JavaScript -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
        
        <script type="text/javascript">
            
            var ref = new Firebase("https://randomquote.firebaseio.com/");
            
            // get size of firebase database
            Object.size = function(obj) {
                var size = 0, key;
                for (key in obj) {
                    if (obj.hasOwnProperty(key)) size++;
                }
                return size;
            };
            
            var chosen, entries, quote, quotes, filledOut;
            
            function getQuote() {
	        	$("#quote-body, #auth").empty();
                
                entries = Object.size(quotes);
            
                chosen = Math.floor((Math.random() * entries));
                
                quote = quotes[chosen];
                
                $("#quote-body").append(quote[1]);
                
                $("#auth").append(quote[0]);
            }
            
            var authUser = function() {
	            
	            ref.authWithPassword({
					email:    $("#email").val(),
					password: $("#password").val()
					}, function(error, userData) {
						if (error) {
							console.log("Error logging in: ", error);
							Materialize.toast(error, 4000);
	  					} else {
	    					console.log("Successfully logged in with: ", userData.uid);
	    					$('#modal1').closeModal();
							$("#user").attr("href", "#modal2");
							$("#quote-submit").removeClass("unregistered");
							
							var userRef = ref.child("users/" + userData.uid + "/username");
							
							userRef.once("value", function(snapshot) {
								Materialize.toast('Welcome, ' + snapshot.val() + '!', 4000);
							})
							
	  					}
				});
	
            }
            
            function check_form(){
				var flag = true;
				$('form .validate').each(function(){
					if ($(this).val() == "" || $(this).hasClass("invalid")) {
						flag =  false;
        			}
    			});

				return flag;
			}
            
            $(document).ready(function() {
	            
	            // retrieve lates set of quotes
	            ref.on("value", function(snapshot) {
		            
		            // was using old firebase JSON
		            // TODO restructure JSON
		        
            		quotes = snapshot.val();
            		$("#quote-body").append(quotes[0][1]);
            		$("#auth").append(quotes[0][0]);
            	});
            	
            	$('.modal-trigger').leanModal();
            	$(".button-collapse").sideNav();
            	
            	// if user logged in, enable quote submission, else notify via toast that
            	// he must be logged in to submit post
            	var authData = ref.getAuth();
            	
            	if (authData) {
	            	console.log("Authenticated user with uid: ", authData.uid);
	            	$("#user").attr("href", "#modal2");
	            	$("#quote-submit").removeClass("unregistered");
            	} else {
	            	$("#quote-submit").addClass("unregistered");
	            	// wait 5 seconds and tell all users to create account
					setTimeout(function() {
						Materialize.toast('Log in to save your favorite quotes!', 4000);
  					}, 5000);
            	}
            });
            
            $("#rand").on("click", getQuote);
            
            $("#quote-submit").on("click", function() {
	            
	            if($(this).hasClass('unregistered')) {
		            Materialize.toast('register to submit quotes', 4000);
	            } else {
		            $('#modal3').openModal();
	            }
            });
            
            $("#register-user").click( function() {
	            
	           	filledOut = check_form();
	            
	            if (!filledOut){
					Materialize.toast('please fill form properly!', 4000);
				} else {
					
					ref.createUser({
		            	email: $("#email").val(),
						password: $("#password").val()
		            }, function(error, userData) {
			           if (error) {
				           console.log("Error creating user: ", error);
			           } else {
				           console.log("Successfully created user account with uid: ", userData.uid);
				         
				           var usersRef = ref.child("users");
				           var userInfo = {};
				           userInfo[userData.uid] = {
					           username: $("#username").val(),
					           name: $("#name").val(),
					           email: $("#email").val(),
				           };
				           
				           usersRef.update(userInfo);
				           
						   authUser();
			           } 
		            });
				}
	            
            });
            
            // request for quote submission
            // push quote to firebase
            
            $("#quote-req").click( function() {
	            
	            filledOut = check_form();
	            
	            if (!filledOut){
		            Materialize.toast('Are both fields filled?', 4000);
	            } else {
		            var quoteRef = ref.child("quotes");
					var author = $("#author").val();
					var quoteCont = $("#quote-text").val();
					var fBaseContents = {
						author: author,
						quote: quoteCont,
						submitted: ref.getAuth().uid
					};
		            
		            quoteRef.push(fBaseContents);
		            
		            $("#quote-text, #author").val("");
		            $('#modal3').closeModal();
	            }
	            
	            
            });
            
            $("#auth-user").click(authUser); 
            
            $("#unauth").click(function() {
		    	ref.unauth();
		    	$("#user").attr("href", "#modal1");
		    	$("#quote-submit").addClass("unregistered");
				Materialize.toast('You are now logged out!', 4000);
            });
            // TODO add logout capabilities
            // use .unauth
            // remove add quote capabilities
            // which means wipe href and .modal-trigger
            
        </script>
	</body>
</html>