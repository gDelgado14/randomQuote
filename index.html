<!DOCTYPE html>
<html>
	<head>
		
		<title>Free Code Camp | Random Quote</title>
		
		<!-- Compiled and minified CSS -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">
        
        <!--Import Google Icon Font-->
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" data-font="test">
		
        <!--Let browser know website is optimized for mobile-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        
        <!-- include Firebase library -->
        <script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
        
        <style>
	        
            h1,
            h4 {
                font-weight: light;
                font-style: italic;
            }
            
            .brand-logo {
	            position: relative;
	            left: 30px;
            }
            
            #rand-quote-div {
	            width: 243px;
            }
            
			#quote-req {
				margin-left: 15px;
			}
			
			i {
				color: white;
			}
			
			.favorited i {
				color: yellow;
			}
			
			footer a {
				border: 1px solid grey;
				padding: 5px 2px;
				border-radius: 5%;
				background-color: rgba(255,255,255,.4);
			}
			
			footer a:hover {
				border: 1px solid grey;
				padding: 5px 2px;
				border-radius: 5%;
				background-color: rgba(255,255,255,.8);
			}
            
        </style>
	</head>
	<body>
		
		
		<nav>
		    <div class="nav-wrapper">
		      <a href="#" class="brand-logo"><i class="medium material-icons">chat_bubble_outline</i></a>
		      <a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>
		      <ul class="right hide-on-med-and-down">
		        <li>
		        	<a id="user" class="modal-trigger tooltipped" data-position="bottom" data-delay="40" data-tooltip="account" href="#modal1"><i class="material-icons">perm_identity</i></a>
		        </li>
		      </ul>
		      <ul class="side-nav" id="mobile-demo">
			      <li>
				  	<a id="user" class="modal-trigger" href="#modal1"><i class="material-icons">perm_identity</i></a>
			      </li>
      		  </ul>
		    </div>
	  	</nav>
	  	
		<main>
	    	<div class="container">
	        	
	        	<div class="row">
	    	        <h1 class="col s8 offset-s3 red-text text-lighten-2">Your Daily Quotes</h1>
	        	</div>
	        	
	        	<div class="row">
	                <div class="col offset-m3 s12 m6">
	                    <div class="card teal lighten-2 hoverable">
	                        <div class="card-content white-text">
	                            <span class="card-title">Today's Quote</span>
	                            <a href="#!" class="tooltipped secondary-content unregistered" data-position="top"  data-delay="30" data-tooltip="save this quote!" id="fav"><i class="material-icons">grade</i></a>
	                            <p id="quote-body"></p>
	                        </div>
	                        <div class="card-action">
	                            <blockquote>
	                                <span class="red-text text-lighten-4" id="auth"></span>
	                            </blockquote>
	                        </div>
	                    </div>
	                </div>
	        	</div> <!-- /.row -->
	        	
	        	<div class="row">
	            	<div id="rand-quote-div" class="col s4 m4 offset-m3 offset-s3">
	                	<a class="waves-effect waves-light btn" id="rand">random quote</a>
	            	</div> <!-- /.btn -->
	            	<div class="col s4">
		            	<a class="waves-effect waves-light btn" id="quote-submit">submit quote</a>
	            	</div>
	        	</div> <!-- /.row -->
	    	</div> 
	    	
	    	<footer class="page-footer">
				<div class="container">
	            <div class="row">
	              <div class="col s12">
	                <h5 class="white-text">Random Quotes</h5>
	                <p class="grey-text text-lighten-4">This is an extension of <a href="http://www.freecodecamp.com/">Free Code Camp's</a> <strong><a href="http://www.freecodecamp.com/challenges/zipline-build-a-random-quote-machine">Random Quote Challenge</a></strong></p>
	              </div>
	            </div>
	          </div>
	          <div class="footer-copyright">
	            <div class="container">
	            2015 - Made with &#9829; by <a href="http://giorgiodelgado.ca/">Giorgio Delgado</a> 
	            <a class="right" href="https://github.com/gdelgado14">GitHub</a>
	            </div>
	          </div>
        	</footer>
		</main>
		
		

		<!-- Modal Structure -->
		<div id="modal1" class="modal">
			<div class="modal-content">
				<h4 class="red-text text-lighten-2 sign-up">Sign Up for YDQ!</h4>
				<h4 class="red-text text-lighten-2 sign-in" style="display: none">Welcome Back</h4>
				<div class="row">
					<a href="#" class="btn-flat sign-up" onClick="$('.sign-up').hide(); $('.sign-in').show()">Or Sign In</a>
					<a href="#" class="btn-flat sign-in" onClick="$('.sign-in').hide(); $('.sign-up').show()" style="display: none">Sign Up</a>
				</div>
				<div class="row">
					<form class="col s12" id="signup-form">
						<div class="row sign-up">
							<div class="input-field col s6">
								<input id="name" type="text" class="validate">
								<label for="first_name">Name</label>
		        			</div>
					        <div class="input-field col s6">
					          <input id="username" type="text" class="validate">
					          <label for="last_name">Username</label>
					        </div>
		      			</div>
		      			<div class="row">
							<div class="input-field col s6">
								<input id="email" type="email" class="validate">
								<label for="email">Email</label>
							</div>
							<div class="input-field col s6">
								<input id="password" type="password" class="validate">
								<label for="password">Password</label>
							</div>
		      			</div>
						<div class="row">
							<a href="#" id="register-user" class="btn sign-up">Sign Up</a>
							<a href="#" id="auth-user" style="display: none" class="btn sign-in">Log In</a>
						</div>
		    		</form>
		 		</div>
			</div>
			<div class="modal-footer">
			  <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Close</a>
			</div>
		</div>
		
		<div id="modal2" class="modal bottom-sheet modal-fixed-footer">
			<div class="modal-content">
				<h3 class="center-align">Quotes HQ</h3>
				<h6 class="center-align red-text text-lighten-2">Logged in as: <span id="hq-user"></span></h6>
				
				
				<ul class="collection with-header">
					<li class="collection-header"><h4>Your Saved Quotes</h4></li>
			        <div id="HQ-quotes">
					</div>
			    </ul>

    		</div>
			<div class="modal-footer">
				<a href="#!" id="unauth" class="modal-action modal-close waves-effect waves-green btn-flat">Log Out</a>
				<a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat">Close</a>
	    	</div>
  		</div>
  		
  		<div id="modal3" class="modal modal-fixed-footer">
  			<div class="modal-content">
  				<h4 class="red-text text-lighten-2">Submit A Quote</h4>
  				<div class="row">
  					<form class="col s12">
						<div class="row">
							<div class="input-field col s6 offset-s3">
							  <textarea id="author" class="materialize-textarea validate"></textarea>
							  <label for="auth">author</label>
							</div>
						</div>
						<div class="row">
							<div class="input-field col s10 offset-s1">
							  <textarea id="quote-text" class="materialize-textarea validate"></textarea>
							  <label for="quote-text">quote</label>
							</div>
						</div>
					</form>
				</div>
    		</div>
			
			<div class="modal-footer">
				<a class="waves-effect waves-light btn" id="quote-req">Submit</a>
				<a class="modal-action modal-close waves-effect waves-green btn">Close</a>
    		</div>
  		</div>
		
       	
        <!--Import jQuery before materialize.js-->
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <!-- Compiled and minified JavaScript -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
        
        <script type="text/javascript">
            
            var chosen, entries, quote, quotes, filledOut, quoteid;
            
            var ref = new Firebase("https://randomquote.firebaseio.com/"),
            	quotesRef = ref.child("quotes"),
            	quotesObj = {};
            
            // get size of firebase database
            Object.size = function(obj) {
                var size = 0, key;
                for (key in obj) {
                    if (obj.hasOwnProperty(key)) size++;
                }
                return size;
            };
            
            function getQuote() {
	            
	            var tempid;
	            
	        	$("#quote-body, #auth").empty();
                
                // number of quotes
                entries = Object.keys(quotesObj).length;
                
               	// based on number of quotes, choose random index
				// of quote objects
                chosen = Math.floor((Math.random() * entries));
                
                // the ID of the chosen quote
                tempid = Object.keys(quotesObj)[chosen];
                
                // make sure we don't retrieve the same quote
                // twice in a row
                while (quoteid === tempid) {
	                chosen = Math.floor((Math.random() * entries));
	                tempid = Object.keys(quotesObj)[chosen];
                }
                
                quoteid = tempid;
                
                // the object of a single quote
                // contains author, quote, and submitted
                quote = quotesObj[quoteid];
    
                $("#quote-body").append(quote["quote"]);
                
                $("#auth").append(quote.author);
                
                // if user logged in, cross reference list
                // of fav quotes and if current quote is favorited 
                // change css of quote to color: yellow
                // add id of #favorited to signify that
                var loggedIn = ref.getAuth();
                
                if (loggedIn) {
	                
					ref.child("users/" + loggedIn.uid).once("value", function(s) {
						if (s.hasChild('favorites')) {
							if (s.val().favorites.indexOf(quoteid) > -1) {
								$("#fav").toggleClass("favorited");
							}
						}
					});
				}
                
            }
            
            function dashSetup() {
	            // set up modal2 (user dashboard)
				// for every favorite, paste quote on dash
				ref.child("users/" + ref.getAuth().uid + "/favorites").once("value", function(s) {
					if (s.hasChildren()) {
			            s.val().forEach(function(id) {
				            var currQuote;
				            quotesRef.child(id).once("value", function(s) {
					            currQuote = s.val();
				            });
				            $("#HQ-quotes").append('<li class="collection-item"><p>' + currQuote["quote"] + '</p><h6><strong> - ' + currQuote["author"] + '</strong></h6></li>');
			            });
		            }
				});
				//
				
				$("#fav").removeClass('unregistered');
				
				ref.child('users/' + ref.getAuth().uid).once('value', function(s) {
					$("#hq-user").append(s.val().username);
					
					// verify current quote as already favorited
					if (s.hasChild('favorites')) {
						if (s.val().favorites.indexOf(quoteid) > -1) {
							console.log('have');
							$("#fav").toggleClass("favorited");
						}
					}
				});
				
            }
            
            // listening to additional changes once logged on
            ref.child("users/" + ref.getAuth().uid + "/favorites").on("child_added", function(s) {
	            console.log("llooooo: ", s.val());
	        	if (s.hasChildren()) {
				    s.val().forEach(function(id) {
						var currQuote;
					    quotesRef.child(id).once("value", function(s) {
							currQuote = s.val();
					    });
					    
					    $("#HQ-quotes").append('<li class="collection-item"><p>' + currQuote["quote"] + '</p><h6><strong> - ' + currQuote["author"] + '</strong></h6></li>');
				    });
		        } 
            });
            
            //
            ref.child("users/" + ref.getAuth().uid + "/favorites").on("child_removed", function(s) {
	            $("#HQ-quotes").empty();
	            
	            if (s.hasChildren()) {
				    s.val().forEach(function(id) {
						var currQuote;
					    quotesRef.child(id).once("value", function(s) {
							currQuote = s.val();
					    });
					    
					    $("#HQ-quotes").append('<li class="collection-item"><p>' + currQuote["quote"] + '</p><h6><strong> - ' + currQuote["author"] + '</strong></h6></li>');
				    });
		        }
            });
            
            var authUser = function() {
	            
	            ref.authWithPassword({
					email:    $("#email").val(),
					password: $("#password").val()
					}, function(error, userData) {
						if (error) {
							console.log("Error logging in: ", error);
							Materialize.toast(error, 4000);
	  					} else {
	    					console.log("Successfully logged in with: ", userData.uid);
	    					$('#modal1').closeModal();
							$("#user").attr("href", "#modal2");
							$("#quote-submit").removeClass("unregistered");
							
							var userRef = ref.child("users/" + userData.uid + "/username");
							
							userRef.once("value", function(snapshot) {
								Materialize.toast('Welcome, ' + snapshot.val() + '!', 4000);
							});
							
							$("#email, #password").val("");
							
							dashSetup();
	  					}
				});
            }
            
            function check_form(){
				var flag = true;
				$('#signup-form .validate').each(function(){
					if ($(this).val() == "" || $(this).hasClass("invalid")) {
						flag =  false;
        			}
    			});

				return flag;
			}
            
            $(document).ready(function() {
	            
	            // used to keep up-to-date version of all quotes in firebase
				// stored clientside using quotesObj
				quotesRef.on("value", function(snap) {
            		quotesObj = snap.val();
            		getQuote();
        		});

            	$('.modal-trigger').leanModal();
            	$(".button-collapse").sideNav();
            	
            	// if user logged in, enable quote submission, else notify via toast that
            	// he must be logged in to submit post
            	var authData = ref.getAuth();
            	
            	if (authData) {
	            	console.log("Authenticated user with uid: ", authData.uid);
	            	$("#user").attr("href", "#modal2");
	            	$("#quote-submit").removeClass("unregistered");
	            	dashSetup();
            	} else {
	            	$("#quote-submit").addClass("unregistered");
	            	// wait 5 seconds and tell all users to create account
					setTimeout(function() {
						Materialize.toast('Log in to save your favorite quotes!', 4000);
  					}, 5000);
            	}
            });
            
            $("#rand").on("click", getQuote);
            
            $("#quote-submit").on("click", function() {
	            
	            if($(this).hasClass('unregistered')) {
		            Materialize.toast('register to submit quotes', 4000);
	            } else {
		            $('#modal3').openModal();
	            }
            });
            
            $("#register-user").click( function() {
	            
	           	filledOut = check_form();
	            
	            if (!filledOut){
					Materialize.toast('please fill form properly!', 4000);
				} else {
					
					ref.createUser({
		            	email: $("#email").val(),
						password: $("#password").val()
		            }, function(error, userData) {
			           if (error) {
				           console.log("Error creating user: ", error);
			           } else {
				           console.log("Successfully created user account with uid: ", userData.uid);
				         
				           var usersRef = ref.child("users");
				           var userInfo = {};
				           userInfo[userData.uid] = {
					           username: $("#username").val(),
					           name: $("#name").val(),
					           email: $("#email").val(),
				           };
				           
				           usersRef.update(userInfo);
				           
						   authUser();
			           } 
		            });
				}
	            
            });
            
            // request for quote submission
            // push quote to firebase
            $("#quote-req").click( function() {
	            
	            if ($("#author").val() === "" || $("#quote-text").val() === ""){
		            Materialize.toast('Are both fields filled?', 4000);
	            } else {
					var author = $("#author").val();
					var quoteCont = $("#quote-text").val();
					var fBaseContents = {
						author: author,
						quote: quoteCont,
						submitted: ref.getAuth().uid
					};
		            
		            quotesRef.push(fBaseContents);
		            
		            $("#quote-text, #author").val("");
		            $('#modal3').closeModal();
	            }

            });
            
            $("#auth-user").click(authUser); 
            
            $("#unauth").click(function() {
		    	ref.unauth();
		    	$("#user").attr("href", "#modal1");
		    	$("#quote-submit, #fav").addClass("unregistered");
		    	$("#fav").removeClass("favorited");
		    	$("#hq-user, #HQ-quotes").empty();
				Materialize.toast('You are now logged out!', 4000);
            });
            
            $("#fav").click(function() {
	            
	            if ($(this).hasClass('unregistered')) {
		            
		            Materialize.toast('register to save quotes', 4000);
		            
	            } else {
	            	
		            $(this).toggleClass("favorited");
		            
		            var favNode = ref.child("users/" + ref.getAuth().uid + "/favorites");
		            
		            if ($(this).hasClass("favorited")) {
			            // add to list of favorites
			            favNode.once("value", function(s) {
			            	if (s.hasChildren()) {
				            	// add to array of existing quote ids
								favNode.set([quoteid].concat(s.val()), function(e) {
					            	if (e) {console.log(e);}
				            	});
			            	} else {
				            	// create array consisting of first quote id
								favNode.set([quoteid], function(e) {
					            	if (e) {console.log(e);}
				            	});
			            	}
		            	});
		            } else {
			            // remove from list of favorites
			            favNode.once("value", function(s) {
				            // new array, removes current
				            // quote from favorites node
				            var cleanedUp = s.val().filter(function(id) {
					            return id !== quoteid;
				            });
				            
				            favNode.set(cleanedUp, function(e) {
					            if (e) {console.log(e);}
				            })
			            })
		            }
		      
	            }
	            
            });
            
          
            
        </script>
	</body>
</html>